# [우아한테크세미나] 190620 우아한 객체지향 by 우아한형제들

객체지향에서 제시하는 다양한 설계원칙와 개념들을 실제 프로젝트에 적용하기 위해서 고려해야 하는 가장 중요한 요서는 **변경과 의존성**

의존성이라는 압력에 따라 설계를 진화시키는 과정을 통해 효과적이고 실용적인 객체지향 설계가 어떤 모습을 띄는 지를 살펴본다.

TODO 강의 55분 전 내용(기본적인 객체 연관관계 정리)을 정리해야함

### 객체간 여러 의존성 끊기

- 방법
    - 중간객체를 이용한 의존성 사이클 끊기
        - 장점
    - **연관관계 다시 살펴보기**
        - Order에서 OrderLineItem으로 탐색 가능. 즉 Order가 뭔지 알면 Order를 통해 원하는 OrderLineItem을 찾을 수 있다.
        - 객체 참조를 통해 연관관계의 문제점?
            - **place() → :Order → validate() → :OrderLineItem**
            
            ```java
            class Order{
            	**private List<OrderLineItem> orderLineItmes;**
            
            	public void place(){
            		validate();
            		ordered();
            	}
            
            	private void validate(){
            		**for(OrderLineItem orderLineItme : orderLineItmes){**
            			orderLineItme.validate();
            		}
            	}
            }
            ```
            
            - 협력을 위해 필요하지만 **두 객체 사이의 결합도가 놓아짐 ( 소위 객체지향 설계의 원칙, SOILD의 D(IP) : 의존관계 역전 원칙,추상화에 의존 )**
            - 성능문제 - 어디까지 조회할 것인가?
                - 메모리 상에 있을 때는 큰 이슈가 되지 않지만, ORM 이나 DB로 직접 매핑을 할려고 할때는.. 헬게이트가 걸린다. LazyLoading 문제!
                - OpenSession In View 로 해결? 사실 이것도 세션이 presentaion 까지 혹은 service 레이어 까지 열려있는 지에 대한 문제지 결국 객체연관관계 탐색과 관련된 것과는 관련 없다. 결국 서비스 레이스에서 무분별한 객체탐색에 대한 욕구. 그리고 어디까지 읽어야 하는 지에 대한 가이드가 없다. 어디까지 읽어야하나? 어떻게 LazyLoading 문제를 해결해야 하나?
            - 수정 시 도메인 규칙을 함께 적용할 경계는?
                
                ![스크린샷 2022-05-21 오후 1.49.35.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_1.49.35.png)
                
                ![스크린샷 2022-05-21 오후 1.49.40.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_1.49.40.png)
                
                - Order 의 상태를 변경할 때 연관된 도메인 규칙을 함께 적용해야 하는 객체의 범위는 ?
                - 객체참조를 통해서 수정하고 있는 모든 것들이 하나의 트랜잭션으로 가버린다. 트랜잭션의 경계도 모호해진다. 실제로 객체에 대한 이야기를 하고 있지만, 실제로 DB나 인프라레이어 쪽에 매핑하다 보면 결국 성능이슈가 발생할 수 밖에 없다.
                - 객체A → 객체B → … → 객체 Z  무분별한 객체참조가 일어날 수 있다.
                    
                    [사용자가 결제 버튼을 누르고 이후의 FLOW](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%A1%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%8C%E1%85%A1%E1%84%80%E1%85%A1%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20%E1%84%87%E1%85%A5%E1%84%90%E1%85%B3%E1%86%AB%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%82%E1%85%AE%E1%84%85%E1%85%B3%E1%84%80%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%AE%E1%84%8B%E1%85%B4%20FLOW%20ac404fb3400f4bf3895c5f9cbcfbe1d8.md)
                    

- 어떤 객체들을 묶고 어떤 객체들을 분리할 것인가?
    - 간단한 규칙
        - 함께 생성되고 함께 삭제되는 객체들을 함께 묶어라
        - 도메인 제약사항을 공유하는 객체들을 함께 묶어라
        - **가능하면 분리하라(하지만 비지니스 룰에 따라서 결정된다)**
            
            ![스크린샷 2022-05-21 오후 2.38.09.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.38.09.png)
            

### 새롭게 묶은 객체 그룹

![스크린샷 2022-05-21 오후 2.49.27.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.49.27.png)

경계 안의 객체는 참조를 이용해 접근 ( 안묶을 수도 있지만 , 묶는 것이 편하다 )

- 같이 생성되거나, 삭제, 수정되는 것들에 대해서 casecade 룰을 줄 수 있다
- 경계 밖의 객체는 ID를 이용해 접근, ID 를 이용해서 연관관계 설정
    
    ![스크린샷 2022-05-21 오후 2.58.49.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.58.49.png)
    
    ![스크린샷 2022-05-21 오후 3.00.46.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_3.00.46.png)
    
    ![스크린샷 2022-05-21 오후 3.04.14.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_3.04.14.png)
    
    ![스크린샷 2022-05-21 오후 3.04.27.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_3.04.27.png)
    
    ![스크린샷 2022-05-21 오후 4.21.51.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.21.51.png)
    
    ![스크린샷 2022-05-21 오후 4.38.31.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.38.31.png)
    

객체안에 validation 을 넣어야 하는 강박관념

객체안에 만약에 그 객체안의 상태를 조금 체크하면 OK,  근데 그 객체를 validation 하기 위해 여러객체의 validation 을 체크해야한다 ? ⇒ 응집도가 떨어짐 

![스크린샷 2022-05-21 오후 5.08.42.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.08.42.png)

![스크린샷 2022-05-21 오후 5.09.31.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.09.31.png)

### 해결1 - 절차지향 로직

![스크린샷 2022-05-21 오후 5.14.23.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.14.23.png)

⇒ 아직이다. 디펜던시를 그려보자. 정말 잘 된 설계일까?

![스크린샷 2022-05-21 오후 5.15.51.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.15.51.png)

⇒ 인터페이스를 이용해서 의존성을 역전시키자.

![스크린샷 2022-05-21 오후 5.16.58.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.16.58.png)

### 패키지 의존성

![스크린샷 2022-05-21 오후 5.18.35.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.18.35.png)

## 두번째 방법

![스크린샷 2022-05-21 오후 5.18.58.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.18.58.png)

order 라는 것이 바뀌었을 때 Delivery와 shop 도 같이 바꾼다.

이 로직을 한눈에 띄게 하고 싶은데 이건 잘게 찢어서 느슨하게 하고 싶다.

객체간의 결합도는 낮지만 로직간의 결합도는 명확하게 보여주고 싶다. 도메인 이벤트는 

A 로직이 끝나고 B와 C의 상태도 바뀌게 하고 싶다! 

 

![스크린샷 2022-05-21 오후 5.21.17.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.21.17.png)

![스크린샷 2022-05-21 오후 5.34.33.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.34.33.png)

Spring data 에서 제공함. 도메인 이벤트 발행 로직을 직접 놓으면 좋지만, AbstractAggregateRoot 상속 받으면  제공해줌. 레지스터 이벤트 제공해줌. commit 시 이벤트 발행해줌

Shop 이벤트 핸들러

- Order 쪽에서 상태가 변경되어서 이벤트가 발행되었을 때 헨들러 쪽에서 이벤트를 받아 처리한다.

```java

@Component
public class BillShopWithOrderDeliveredEventHandler{

	@Async
	@Eventlistener
	@Transational
	public void handle(OrderDeliveredEvent event){
		Shop shop = shopRepository.findById(event.getShopId())
		shop.billCommissionFee(event.getTotalPrice());
	}
}
```

![스크린샷 2022-05-21 오후 5.39.50.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.39.50.png)

### Domain Event 추가 후에 어떻게 되었을까?

![스크린샷 2022-05-21 오후 5.41.17.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.41.17.png)

![스크린샷 2022-05-21 오후 5.41.27.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.41.27.png)

패키지를 분리한다. Shop 이 Order 에 의존성 걸리는 문제를 끊을 수 있다.

![스크린샷 2022-05-21 오후 5.43.03.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.43.03.png)

Event Handler 가 의존하는 코드를 Shop 에서 분리

```java
public class Shop{
	private Ratio commissionRate;
	pricate Money commissiond = Money.ZERO;
	
	public void billCommissionFee(Money price){
		commission = commission.plus(commissionRate.of(price));
	}
}
```

Event Handler 가 의존하는 코드를 Shop 에서 분리한다.

```java
public class Shop {
	private Ratio commissionRate;

	**public Money calculateCommissionFee(Money price){**
		return commissionRate.of(price);
	}
}
```

```java
public class Billing{
	private Long shopId;
	private Money commission = Money.ZERO;

	**public void billCommissionFee(Money commission){**
		commission = commission.plus(commission);
	}
}
```

```java
@Component
public class BillShopWithOrderDeliveredEventHandler{
	@Async 
	@EventListener
	@Transational
	public void handle(OrderDeliveredEvent event){
		Shop shop = shopRepository.findById(event.getShopId());
		Billing billing = billingRepository.findByShopId(event.getShopId())
																					.orElse(new Billing(event.getShopId));
	}
}
```

![스크린샷 2022-05-21 오후 5.53.28.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.53.28.png)

![스크린샷 2022-05-21 오후 5.54.20.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.54.20.png)

## 의존성과 시스템 분리

Domain Event 사용 전의 의존성

![스크린샷 2022-05-21 오후 5.56.34.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.56.34.png)

![스크린샷 2022-05-21 오후 5.56.50.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.56.50.png)

실제로 배달의 민족에서 많이 사용하는 구조

![스크린샷 2022-05-21 오후 5.57.48.png](%5B%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%E1%84%90%E1%85%A6%E1%84%8F%E1%85%B3%E1%84%89%E1%85%A6%E1%84%86%E1%85%B5%E1%84%82%E1%85%A1%5D%20190620%20%E1%84%8B%E1%85%AE%E1%84%8B%E1%85%A1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%A2%E1%86%A8%E1%84%8E%E1%85%A6%E1%84%8C%E1%85%B5%E1%84%92%E1%85%A3%E1%86%BC%20by%20%E1%84%8B%20919454897368488499feca18424bc780/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-21_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.57.48.png)

- 한통으로 하더라도 디펜던지 관리를 해야한다.
- 만약 시스템을 찢고 싶다?